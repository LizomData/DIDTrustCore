package vulnerabilityScanningController

import (
	"DIDTrustCore/common"
	"DIDTrustCore/controller/sbomController"
	"DIDTrustCore/model/requestBase"
	"DIDTrustCore/util/dataBase/scanReportDb"
	"DIDTrustCore/util/grype/grypeService"
	"fmt"
	"github.com/gin-gonic/gin"
	"os"
	"path/filepath"
	"strings"
	"time"
)

// @Summary 生成分析漏洞接口
// @Description 根据已经生成的sbom生成漏洞分析报告
// @Tags 漏洞分析
// @Accept json
// @Produce json
// @Param Authorization	header		string	true	"jwt"
// @Param body body ScanRequest true "分析参数"
// @Success 200 {object} model.ScanReport "SBOM清单信息"
// @Router /api/v1/vulnerability/scan [post]
func scan(c *gin.Context) {
	var req ScanRequest
	if err := c.ShouldBindJSON(&req); err != nil {
		c.JSON(requestBase.ResponseBody(requestBase.ParameterError, "无效的请求参数", gin.H{}))
		return
	}

	// 验证并解析文件URL
	filename, err := validateFileURL(req.SbomFileUrl)
	if err != nil {
		c.JSON(requestBase.ResponseBody(requestBase.FileNotFound, "文件URL无效,检查sbom文件路径", gin.H{}))
		return
	}

	// 获取本地文件路径
	sbomPath := filepath.Join(sbomController.Generator.Config.SBOMStorageDir, filename)
	if _, err := os.Stat(sbomPath); os.IsNotExist(err) {
		c.JSON(requestBase.ResponseBody(requestBase.FileNotFound, "sbom不存在,检查sbom上传状态", gin.H{}))
		return
	}

	// 生成唯一文件名
	reportFilename := fmt.Sprintf("report_%d_%d.json", time.Now().UnixNano(),
		time.Now().Nanosecond())

	if err := grypeService.Service.RunGrypeWrapper(reportFilename, sbomPath); err != nil {
		c.JSON(requestBase.ResponseBody(requestBase.NotSbomReport, "分析漏洞:"+err.Error(), gin.H{}))
		return
	}

	user, _ := common.GetUserFromContext(c)
	record, err := scanReportDb.Svc.CreateRecord(user.ID, req.DidID, reportFilename, grypeService.Service.Config.PublicPath+reportFilename)
	if err != nil {
		c.JSON(requestBase.ResponseBody(requestBase.NotSbomReport, "保存记录错误:"+err.Error(), gin.H{}))
		return
	}
	c.JSON(requestBase.ResponseBodySuccess(record))

}

// 验证文件URL并提取文件名
func validateFileURL(url string) (string, error) {
	if !strings.HasPrefix(url, sbomController.Generator.Config.PublicPath) {
		return "", fmt.Errorf("非法的文件路径")
	}
	filename := strings.TrimPrefix(url, sbomController.Generator.Config.PublicPath)
	if filename == "" || strings.Contains(filename, "..") {
		return "", fmt.Errorf("无效的文件名")
	}
	return filename, nil
}
