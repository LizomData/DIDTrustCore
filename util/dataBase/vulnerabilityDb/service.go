package vulnerabilityDb

import (
	"DIDTrustCore/model"
	"DIDTrustCore/util/dataBase"
	"errors"
	"gorm.io/gorm"
	"time"
)

var Svc = newService(dataBase.Db_vulnerability)

type VuyDbService struct {
	db *gorm.DB
}

func newService(db *gorm.DB) *VuyDbService {
	return &VuyDbService{db}
}

func (s *VuyDbService) ListVulnerability(page, size int) ([]model.Blobs, error) {
	if page < 1 {
		page = 1
	}
	if size < 1 || size > 100 {
		size = 20
	}

	offset := (page - 1) * size
	var blobs []model.Blobs

	err := s.db.
		Table("vulnerability_handles").
		Select("blobs.*").
		Joins("JOIN blobs ON vulnerability_handles.blob_id = blobs.id").
		Order("vulnerability_handles.id ASC").
		Offset(offset).
		Limit(size).
		Scan(&blobs).Error

	return blobs, err
}

func (s *VuyDbService) ListVulnerabilityByUser(user_id uint, page, size int) ([]model.BlobsCustomer, error) {
	if page < 1 {
		page = 1
	}
	if size < 1 || size > 100 {
		size = 20
	}
	offset := (page - 1) * size

	var blobs []model.BlobsCustomer

	result := s.db.Where("user_id = ?", user_id).
		Offset(offset).
		Limit(size).
		Order("created_at DESC").
		Find(&blobs)
	return blobs, result.Error
}

func (s *VuyDbService) CreateRecord(userid uint, value string) (*model.BlobsCustomer, error) {
	record := &model.BlobsCustomer{
		UserID:    userid,
		Value:     value,
		CreatedAt: time.Now().Unix(),
		UpdatedAt: time.Now().Unix(),
	}

	return record, s.db.Transaction(func(tx *gorm.DB) error {
		// 验证必要字段
		if record.UserID == 0 {
			return errors.New("missing required fields")
		}
		return tx.Create(record).Error
	})

}
