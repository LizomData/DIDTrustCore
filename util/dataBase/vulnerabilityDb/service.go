package vulnerabilityDb

import (
	"DIDTrustCore/model"
	"DIDTrustCore/util/dataBase"
	"encoding/json"
	"errors"
	"gorm.io/gorm"
	"time"
)

var Svc = newService(dataBase.Db_vulnerability)

type VuyDbService struct {
	db *gorm.DB
}

func newService(db *gorm.DB) *VuyDbService {
	return &VuyDbService{db}
}

func (s *VuyDbService) ListVulnerability(page, size int) ([]model.Blobs, error) {
	if page < 1 {
		page = 1
	}
	if size < 1 || size > 100 {
		size = 20
	}

	offset := (page - 1) * size
	var blobs []model.Blobs

	err := s.db.
		Table("vulnerability_handles").
		Select("blobs.*").
		Joins("JOIN blobs ON vulnerability_handles.blob_id = blobs.id").
		Order("vulnerability_handles.id ASC").
		Offset(offset).
		Limit(size).
		Scan(&blobs).Error

	return blobs, err
}

func (s *VuyDbService) ListVulnerabilityByUser(user_id uint, page, size int) ([]model.BlobsCustomer, error) {
	if page < 1 {
		page = 1
	}
	if size < 1 || size > 100 {
		size = 20
	}
	offset := (page - 1) * size

	var blobs []model.BlobsCustomer

	result := s.db.Where("user_id = ?", user_id).
		Offset(offset).
		Limit(size).
		Order("created_at DESC").
		Find(&blobs)
	return blobs, result.Error
}

func (s *VuyDbService) CreateRecord(userid uint, value string) (*model.BlobsCustomer, error) {
	record := &model.BlobsCustomer{
		UserID:    userid,
		Value:     value,
		CreatedAt: time.Now().Unix(),
		UpdatedAt: time.Now().Unix(),
	}

	return record, s.db.Transaction(func(tx *gorm.DB) error {
		// 验证必要字段
		if record.UserID == 0 {
			return errors.New("missing required fields")
		}
		return tx.Create(record).Error
	})

}
func (s *VuyDbService) GetRankDistribution(user_id uint) (map[int]int, error) {
	var records []model.BlobsCustomer
	rankStats := make(map[int]int)

	rankStats[1] = 221268
	rankStats[2] = 138292
	rankStats[3] = 82975
	rankStats[4] = 65319
	rankStats[5] = 45317
	// 分批处理数据
	err := s.db.Model(&model.BlobsCustomer{}).
		Where("user_id = ?", user_id).
		Select("user_id, value").
		FindInBatches(&records, 1000, func(tx *gorm.DB, batch int) error {
			for _, record := range records {
				var data model.VulnerabilityData
				// 解析JSON到结构体
				err := json.Unmarshal([]byte(record.Value), &data)
				if err != nil {
					continue
				}
				if len(data.Severities) == 0 {
					continue
				}
				for _, s := range data.Severities {
					rankStats[s.Rank]++
				}
			}
			return nil
		}).Error

	return rankStats, err
}
